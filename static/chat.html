<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Knowledge Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .chat-container {
            height: calc(100vh - 120px);
        }

        .message-container {
            height: calc(100% - 60px);
        }

        .sidebar {
            height: calc(100vh - 60px);
        }

        .typing-indicator:after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 bg-gray-800 text-white flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <button id="new-chat-btn"
                    class="w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition">
                    <i class="fas fa-plus"></i>
                    <span>New Chat</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div id="chat-sessions" class="p-2 space-y-1">
                    <!-- Chat sessions will be loaded here -->
                </div>
            </div>
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center space-x-2">
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="User"
                        class="w-8 h-8 rounded-full">
                    <span>User</span>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <h1 id="current-session-name" class="text-xl font-semibold">New Session</h1>
                <div class="flex space-x-2">
                    <button id="rename-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="delete-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-container flex-1 overflow-y-auto bg-gray-50 p-4">
                <div id="messages" class="message-container space-y-4">
                    <!-- Messages will appear here -->
                    <div class="text-center text-gray-500 py-10">
                        <p>Start a new conversation or select an existing one from the sidebar</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-white border-t border-gray-200 p-4">
                <form id="chat-form" class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="Type your question..."
                        class="flex-1 border border-gray-300 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">Rename Session</h3>
            <input type="text" id="new-session-name" placeholder="Enter new session name"
                class="w-full border border-gray-300 rounded-md py-2 px-4 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end space-x-2">
                <button id="cancel-rename" class="px-4 py-2 border border-gray-300 rounded-md">Cancel</button>
                <button id="confirm-rename" class="px-4 py-2 bg-blue-600 text-white rounded-md">Save</button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isProcessing = false;

        // DOM Elements
        const chatSessionsEl = document.getElementById('chat-sessions');
        const messagesEl = document.getElementById('messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const newChatBtn = document.getElementById('new-chat-btn');
        const renameBtn = document.getElementById('rename-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const currentSessionNameEl = document.getElementById('current-session-name');
        const renameModal = document.getElementById('rename-modal');
        const newSessionNameInput = document.getElementById('new-session-name');
        const cancelRenameBtn = document.getElementById('cancel-rename');
        const confirmRenameBtn = document.getElementById('confirm-rename');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', loadSessions);
        newChatBtn.addEventListener('click', createNewSession);
        chatForm.addEventListener('submit', handleSubmit);
        renameBtn.addEventListener('click', showRenameModal);
        deleteBtn.addEventListener('click', deleteCurrentSession);
        cancelRenameBtn.addEventListener('click', hideRenameModal);
        confirmRenameBtn.addEventListener('click', renameCurrentSession);

        // Functions
        async function loadSessions() {
            try {
                const response = await fetch('/api/list_sessions');
                const sessions = await response.json();

                chatSessionsEl.innerHTML = '';

                if (sessions.length === 0) {
                    createNewSession();
                    return;
                }

                sessions.forEach(session => {
                    const sessionEl = createSessionElement(session);
                    chatSessionsEl.appendChild(sessionEl);

                    // Load the first session by default
                    if (!currentSessionId) {
                        loadSession(session._id);
                    }
                });
            } catch (error) {
                console.error('Error loading sessions:', error);
                showError('Failed to load chat sessions');
            }
        }

        function createSessionElement(session) {
            const sessionEl = document.createElement('div');
            sessionEl.className = `p-2 rounded-md cursor-pointer flex justify-between items-center hover:bg-gray-700 ${currentSessionId === session._id ? 'bg-gray-700' : ''}`;
            sessionEl.dataset.sessionId = session._id;

            sessionEl.innerHTML = `
                <div class="flex items-center space-x-2 truncate">
                    <i class="fas fa-comment-alt"></i>
                    <span class="truncate">${session.name}</span>
                </div>
                <button class="text-gray-400 hover:text-white delete-session-btn" data-session-id="${session._id}">
                    <i class="fas fa-times"></i>
                </button>
            `;

            sessionEl.addEventListener('click', () => loadSession(session._id));

            // Add delete button event listener
            const deleteBtn = sessionEl.querySelector('.delete-session-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteSession(session._id);
            });

            return sessionEl;
        }

        async function loadSession(sessionId) {
            try {
                currentSessionId = sessionId;
                updateActiveSessionUI();

                const response = await fetch(`/api/session_messages/${sessionId}`);
                const messages = await response.json();

                messagesEl.innerHTML = '';

                if (messages.length === 0) {
                    messagesEl.innerHTML = `
                        <div class="text-center text-gray-500 py-10">
                            <p>Start a new conversation</p>
                        </div>
                    `;
                    return;
                }

                messages.forEach(message => {
                    addMessageToUI(message.role, message.content);
                });

                // Scroll to bottom
                messagesEl.scrollTop = messagesEl.scrollHeight;

                // Update session name in header
                const sessionElement = document.querySelector(`[data-session-id="${sessionId}"]`);
                if (sessionElement) {
                    const sessionName = sessionElement.querySelector('span').textContent;
                    currentSessionNameEl.textContent = sessionName;
                }
            } catch (error) {
                console.error('Error loading session:', error);
                showError('Failed to load chat session');
            }
        }

        async function createNewSession() {
            try {
                const response = await fetch('/api/create_session', {
                    method: 'POST'
                });

                const newSession = await response.json();
                const sessionEl = createSessionElement(newSession);

                // Add to top of the list
                chatSessionsEl.insertBefore(sessionEl, chatSessionsEl.firstChild);

                // Load the new session
                loadSession(newSession._id);
            } catch (error) {
                console.error('Error creating new session:', error);
                showError('Failed to create new chat session');
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            const question = userInput.value.trim();
            if (!question || isProcessing) return;

            isProcessing = true;
            userInput.disabled = true;

            // Add user message to UI
            addMessageToUI('user', question);
            userInput.value = '';

            // Show typing indicator
            addMessageToUI('bot', '', true);

            try {
                const response = await fetch('/ask_global_question/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();

                // Remove typing indicator
                const typingIndicator = document.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }

                // Add bot response
                if (data.answer) {
                    addMessageToUI('bot', data.answer);
                } else {
                    addMessageToUI('bot', "Sorry, I couldn't generate a response.");
                }

                // Scroll to bottom
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } catch (error) {
                console.error('Error asking question:', error);

                // Remove typing indicator
                const typingIndicator = document.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }

                addMessageToUI('bot', "Sorry, there was an error processing your request.");
            } finally {
                isProcessing = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        function addMessageToUI(role, content, isTyping = false) {
            if (messagesEl.children.length === 1 && messagesEl.children[0].classList.contains('text-center')) {
                messagesEl.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubbleClass = role === 'user'
                ? 'bg-blue-600 text-white rounded-l-lg rounded-br-lg'
                : 'bg-gray-200 text-gray-800 rounded-r-lg rounded-bl-lg';

            const typingClass = isTyping ? 'typing-indicator' : '';

            messageDiv.innerHTML = `
                <div class="max-w-3/4 ${role === 'user' ? 'ml-10' : 'mr-10'}">
                    <div class="${bubbleClass} ${typingClass} p-3 inline-block">
                        ${content}
                    </div>
                </div>
            `;

            messagesEl.appendChild(messageDiv);

            // Scroll to bottom if not typing indicator
            if (!isTyping) {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        }

        function showRenameModal() {
            if (!currentSessionId) return;

            const sessionElement = document.querySelector(`[data-session-id="${currentSessionId}"]`);
            if (sessionElement) {
                const currentName = sessionElement.querySelector('span').textContent;
                newSessionNameInput.value = currentName;
            }

            renameModal.classList.remove('hidden');
            newSessionNameInput.focus();
        }

        function hideRenameModal() {
            renameModal.classList.add('hidden');
        }

        async function renameCurrentSession() {
            const newName = newSessionNameInput.value.trim();
            if (!newName || !currentSessionId) {
                hideRenameModal();
                return;
            }

            try {
                const response = await fetch(`/api/rename_session/${currentSessionId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newName
                    })
                });

                if (response.ok) {
                    // Update UI
                    const sessionElement = document.querySelector(`[data-session-id="${currentSessionId}"]`);
                    if (sessionElement) {
                        sessionElement.querySelector('span').textContent = newName;
                    }

                    currentSessionNameEl.textContent = newName;
                    hideRenameModal();
                } else {
                    throw new Error('Failed to rename session');
                }
            } catch (error) {
                console.error('Error renaming session:', error);
                showError('Failed to rename chat session');
                hideRenameModal();
            }
        }

        async function deleteCurrentSession() {
            if (!currentSessionId) return;

            if (!confirm('Are you sure you want to delete this chat session?')) {
                return;
            }

            try {
                const response = await fetch(`/api/delete_session/${currentSessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Remove from UI
                    const sessionElement = document.querySelector(`[data-session-id="${currentSessionId}"]`);
                    if (sessionElement) {
                        sessionElement.remove();
                    }

                    // Create a new session or load another one
                    const remainingSessions = document.querySelectorAll('[data-session-id]');
                    if (remainingSessions.length > 0) {
                        loadSession(remainingSessions[0].dataset.sessionId);
                    } else {
                        createNewSession();
                    }
                } else {
                    throw new Error('Failed to delete session');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showError('Failed to delete chat session');
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this chat session?')) {
                return;
            }

            try {
                const response = await fetch(`/api/delete_session/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Remove from UI
                    const sessionElement = document.querySelector(`[data-session-id="${sessionId}"]`);
                    if (sessionElement) {
                        sessionElement.remove();
                    }

                    // If we deleted the current session, load another one
                    if (sessionId === currentSessionId) {
                        const remainingSessions = document.querySelectorAll('[data-session-id]');
                        if (remainingSessions.length > 0) {
                            loadSession(remainingSessions[0].dataset.sessionId);
                        } else {
                            createNewSession();
                        }
                    }
                } else {
                    throw new Error('Failed to delete session');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showError('Failed to delete chat session');
            }
        }

        function updateActiveSessionUI() {
            // Remove active class from all sessions
            document.querySelectorAll('[data-session-id]').forEach(el => {
                el.classList.remove('bg-gray-700');
            });

            // Add active class to current session
            const currentSessionEl = document.querySelector(`[data-session-id="${currentSessionId}"]`);
            if (currentSessionEl) {
                currentSessionEl.classList.add('bg-gray-700');
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
    </script>
</body>

</html>